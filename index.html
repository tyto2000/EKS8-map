<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa povrchů – viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0 }
    #map { height:100% }

    /* Horní banner */
    #banner {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:#111827; color:#e5e7eb; padding:8px 12px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.35); font-family:system-ui, sans-serif; font-size:14px; z-index:1000
    }
    #banner.error { background:#7f1d1d }
    #banner small { color:#9ca3af }

    /* Spodní lišta – legenda */
    #legend {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.96);
      border-top: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 10px;
      backdrop-filter: saturate(120%) blur(4px);
    }
    #legend .title {
      font-size: 13px; color: #111827; font-weight: 600; white-space: nowrap;
    }
    #legend .items {
      display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      flex: 1;
    }
    #legend .chip {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 999px;
      background: #fff; font-size: 12px; color: #111827; white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }
    #legend .swatch {
      width: 14px; height: 14px; border-radius: 50%;
      border: 1px solid rgba(0,0,0,.15);
      flex: 0 0 auto;
    }
    #legend .toggle {
      font-size: 12px; color: #374151; background: #f3f4f6; border: 1px solid #e5e7eb;
      padding: 6px 8px; border-radius: 8px; cursor: pointer; white-space: nowrap;
    }
    #legend.collapsed { height: 38px; overflow: hidden; }
    /* Rezerva dole, ať není popup pod lištou nepraktický */
    .leaflet-bottom { bottom: 56px; }
    @media (max-width: 520px){ #legend { padding: 6px 8px } .leaflet-bottom { bottom: 50px } }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="banner">Načítám poznámky… <small>(když to padne, zkontroluj API key / sdílení / odkaz)</small></div>

  <!-- Spodní legenda -->
  <div id="legend" class="">
    <div class="title">Legenda</div>
    <div class="items" id="legendItems"></div>
    <button class="toggle" id="legendToggle" type="button">Skrýt</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === NASTAVENÍ ZDROJE DAT ===
    // 1) Google Drive API varianta (změň si ID a KEY, nebo nech prázdné)
    const DRIVE_FILE_ID  = "1rXCuZ260GR1ipC3-LE62WRM5I_xMN1gb"; // <- tvoje ID souboru na Drive
    const GOOGLE_API_KEY = "AIzaSyA6lpPAI9V3HDjEY6jYf_7CnFpg2nvl8VQ";         // <- tvůj API key
    const DRIVE_DATA_URL = `https://www.googleapis.com/drive/v3/files/${DRIVE_FILE_ID}?alt=media&key=${GOOGLE_API_KEY}`;

    // 2) Fallback na soubor v repu (nahraj do stejného repa např. data.geojson)
    const LOCAL_DATA_URL = "./data.geojson";

    // 3) Volitelný override ?data=ENCODED_URL (např. jiný Drive/Raw GitHub)
    const urlParams = new URLSearchParams(location.search);
    const override = urlParams.get("data");
    const DATA_URL = override
      ? decodeURIComponent(override)
      : (GOOGLE_API_KEY && GOOGLE_API_KEY !== "PASTE_YOUR_API_KEY_HERE" ? DRIVE_DATA_URL : LOCAL_DATA_URL);

    // === MAPA ===
    const map = L.map("map").setView([50.0755,14.4378], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20,
      attribution: "&copy; OpenStreetMap přispěvatelé"
    }).addTo(map);

    // === Styl: preferuj explicitní barvy/šířky z dat ===
    function styleFor(f){
      const p = f.properties || {};
      if (f.geometry && f.geometry.type === "Point") {
        // body: color -> marker-color -> stroke -> fallback
        const color = p.color || p["marker-color"] || p.stroke || "#38bdf8";
        return { color, fillColor: color, fillOpacity: 0.9, weight: 2 };
      } else {
        // linie: color -> stroke; width -> stroke-width; jinak fallback heuristiky
        let color = p.color || p.stroke;
        let width = Number(p.width ?? p["stroke-width"] ?? 5);

        if (!color) {
          // Fallback jen když v datech barva chybí
          color = "#84cc16";
          if (p.surface === "asfalt" && p.condition === "hladký") color = "#22c55e";
          else if (p.surface === "dlažba") color = "#f59e0b";
          if (p.condition === "výtluky" || p.condition === "nebezpečné") color = "#ef4444";
          if (p.surface === "štěrk") color = "#a3a3a3";
        }
        const opacity = (typeof p["stroke-opacity"] !== "undefined") ? p["stroke-opacity"] : 0.95;
        return { color, weight: width, opacity };
      }
    }

    function showBanner(msg, isError=false){
      const b = document.getElementById("banner");
      b.textContent = msg;
      b.className = isError ? "error" : "";
      if (!isError) setTimeout(()=> b.remove(), 1800);
    }

    // === LEGEND ===
    function buildLegendFromMeta(meta){
      // použij jen pokud meta.categories existují A nejsou prázdné
      if (!meta || !Array.isArray(meta.categories) || meta.categories.length === 0) return null;
      return meta.categories.map(c => ({
        key: c.name || c.id || "Kategorie",
        color: c.color || "#999",
      }));
    }

    function deriveLegendFromFeatures(features){
      const list = Array.isArray(features) ? features : [];
      if (!list.length) return [];

      // Název -> barva, a fallback barva -> label
      const byName = new Map();
      const byColor = new Map();

      for (const f of list) {
        const p = f.properties || {};
        const s = styleFor(f);
        const color = (f.geometry && f.geometry.type === "Point")
          ? (p.color || p["marker-color"] || p.stroke || s.color || "#999")
          : (p.color || p.stroke || s.color || "#999");

        // zkus název v pořadí:
        const name = p.categoryName || p.surface || p.condition || p.categoryId || null;

        if (name) {
          if (!byName.has(name)) byName.set(name, color);
        } else {
          if (!byColor.has(color)) byColor.set(color, `Barva ${color}`);
        }
      }

      const items = [];
      for (const [key, color] of byName.entries()) items.push({ key, color });
      for (const [color, label] of byColor.entries()) items.push({ key: label, color });
      return items;
    }

    function renderLegend(items){
      const wrap = document.getElementById("legendItems");
      wrap.innerHTML = "";
      if (!items || !items.length) {
        const span = document.createElement("span");
        span.textContent = "Žádné kategorie nenalezeny";
        span.style.color = "#6b7280";
        span.style.fontSize = "12px";
        wrap.appendChild(span);
        return;
      }
      for (const it of items) {
        const chip = document.createElement("div");
        chip.className = "chip";
        const sw = document.createElement("span");
        sw.className = "swatch";
        sw.style.background = it.color || "#999";
        chip.appendChild(sw);
        const label = document.createElement("span");
        label.textContent = it.key;
        chip.appendChild(label);
        wrap.appendChild(chip);
      }
    }

    // Toggle legendy
    document.getElementById("legendToggle").addEventListener("click", () => {
      const lg = document.getElementById("legend");
      const collapsed = lg.classList.toggle("collapsed");
      document.getElementById("legendToggle").textContent = collapsed ? "Zobrazit" : "Skrýt";
    });

    // === Načtení dat ===
    async function loadGeoJSON(url){
      try{
        const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now(); // cache-bust
        const res = await fetch(url + bust, { mode:"cors" });
        if(!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);
        const data = await res.json();

        // Vykreslení vrstev
        const layer = L.geoJSON(data, {
          style: styleFor,
          pointToLayer: (f, latlng) => {
            const s = styleFor(f);
            return L.circleMarker(latlng, {
              radius: 6,
              color: s.color,
              fillColor: s.fillColor || s.color,
              fillOpacity: s.fillOpacity ?? 0.9,
              weight: s.weight ?? 2
            });
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const lines = [];
            if (p.surface) lines.push(`<b>${p.surface}</b>`);
            if (p.condition) lines.push(p.condition);
            if (p.tag) lines.push(`<i>${p.tag}</i>`);
            if (p.note) lines.push(p.note.replace(/</g,"&lt;"));
            if (lines.length) layer.bindPopup(lines.join("<br>"));
          }
        }).addTo(map);

        // Zoom na data
        try{
          const bb = layer.getBounds();
          if (bb.isValid()) map.fitBounds(bb.pad(0.1));
        }catch{}

        // Legenda: nejprve meta.categories (jen když nejsou prázdné), jinak z feature-dat
        const metaItems = buildLegendFromMeta(data?.meta);
        const featItems = deriveLegendFromFeatures(data?.features);
        const legendItems = (metaItems && metaItems.length) ? metaItems : featItems;
        renderLegend(legendItems);

        showBanner("Načteno ✔");
      }catch(err){
        console.error("Chyba při načítání GeoJSON:", err);
        showBanner("Nepodařilo se načíst data (API key / sdílení / formát).", true);
      }
    }

    loadGeoJSON(DATA_URL);
  </script>
</body>
</html>
