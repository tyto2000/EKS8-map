<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa povrchů – viewer (ikony jako v editoru)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0 }
    #map { height:100% }
    #banner { position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:#111827; color:#e5e7eb; padding:8px 12px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.35); font-family:system-ui, sans-serif; font-size:14px; z-index:1000 }
    #banner.error { background:#7f1d1d }  #banner small { color:#9ca3af }
    .legend { position:fixed; left:0; right:0; bottom:0; z-index:900; background:rgba(17,24,39,.85);
      color:#e5e7eb; font-family:system-ui,sans-serif; padding:6px 10px; border-top:1px solid rgba(255,255,255,.12);
      backdrop-filter:blur(4px); display:flex; gap:10px; align-items:center; overflow:auto }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.04); white-space:nowrap; font-size:12px }
    .sw { width:14px; height:14px; border-radius:50%; border:1px solid rgba(255,255,255,.25) }
    .iconbox { width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center }
    .pticon { display:inline-flex; align-items:center; justify-content:center }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="banner">Načítám poznámky… <small>(může to být sdílením na Drive / API key)</small></div>
  <div id="legend" class="legend" style="display:none"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // === ZDROJE DAT ===
    const DRIVE_FILE_ID = "1rXCuZ260GR1ipC3-LE62WRM5I_xMN1gb";   // tvoje ID
    const GOOGLE_API_KEY = "AIzaSyA6lpPAI9V3HDjEY6jYf_7CnFpg2nvl8VQ"; // tvůj key (Drive API musí být povolená)
    const DRIVE_API_URL = `https://www.googleapis.com/drive/v3/files/${DRIVE_FILE_ID}?alt=media&key=${GOOGLE_API_KEY}`;
    const LOCAL_DATA_URL = "./data.geojson"; // soubor v repu (kořen)
    // Volitelně parametr ?data=<urlencoded_url>
    const p = new URLSearchParams(location.search);
    const DATA_URL_OVERRIDE = p.get("data") ? decodeURIComponent(p.get("data")) : null;

    // === MAPA ===
    const map = L.map("map").setView([50.0755,14.4378], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 20, attribution: "&copy; OpenStreetMap přispěvatelé"
    }).addTo(map);
    const drawn = new L.FeatureGroup().addTo(map);
    const iconsLayer = new L.FeatureGroup().addTo(map);

    // === IKONY POVRCHŮ (jako editor) ===
    const ICON_SVGS = {
      dot:'<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="3.2" fill="#fff" stroke="#111" stroke-width="1.3"/></svg>',
      brick:'<svg width="16" height="16" viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#fff" stroke="#111" stroke-width="1"/><path d="M2 8 H14 M6 4 V8 M10 8 V12" stroke="#111" stroke-width="1"/></svg>',
      pebble:'<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="5" cy="8" r="2.4" fill="#fff" stroke="#111" stroke-width="1"/><circle cx="11" cy="6" r="1.9" fill="#fff" stroke="#111" stroke-width="1"/><circle cx="11" cy="11" r="1.5" fill="#fff" stroke="#111" stroke-width="1"/></svg>',
      stairs:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M4 12 H12 V10 H10 V8 H8 V6 H6 V4 H4 Z" fill="#fff" stroke="#111" stroke-width="1.1"/></svg>',
      plank:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M2 5 H14 M2 8 H14 M2 11 H14" stroke="#111" stroke-width="1.6"/></svg>',
      triangle:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M8 3 L13 13 H3 Z" fill="#fff" stroke="#111" stroke-width="1.3"/></svg>',
    };

    // === PIKTOGRAMY BODŮ (jako editor) – vždy červené ===
    const POINT_COLOR = "#ef4444";
    const POINT_ICONS = {
      warning:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M12 3L2.5 20h19L12 3z" fill="white" stroke="currentColor" stroke-width="2"/><path d="M12 8v6M12 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
      speed_bump:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M3 16h18" stroke="currentColor" stroke-width="2"/><path d="M4 16c4-6 12-6 16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
      zavora:'<svg viewBox="0 0 24 24" width="100%" height="100%"><rect x="4" y="15" width="3" height="6" fill="white" stroke="currentColor" stroke-width="2"/><rect x="17" y="15" width="3" height="6" fill="white" stroke="currentColor" stroke-width="2"/><rect x="5" y="9" width="14" height="4" rx="1" fill="white" stroke="currentColor" stroke-width="2"/><path d="M6 9.5 L9 12.5 M9 9.5 L12 12.5 M12 9.5 L15 12.5 M15 9.5 L18 12.5" stroke="currentColor" stroke-width="2"/></svg>',
      railcross:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M5 5 L19 19" stroke="white" stroke-width="6" stroke-linecap="round"/><path d="M19 5 L5 19" stroke="white" stroke-width="6" stroke-linecap="round"/><path d="M5 5 L19 19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M19 5 L5 19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>',
      pin:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M12 22s7-6.5 7-12a7 7 0 10-14 0c0 5.5 7 12 7 12z" fill="white" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="10" r="2.5" fill="currentColor"/></svg>'
    };

    // ===== util =====
    function showBanner(msg, isError=false){
      const b = document.getElementById("banner");
      b.textContent = msg; b.className = isError ? "error" : "";
      if (!isError) setTimeout(()=> b.remove(), 1800);
    }
    function lineIcon(key){ return L.divIcon({ html: ICON_SVGS[key]||ICON_SVGS.dot, className:"", iconSize:[16,16], iconAnchor:[8,8] }); }
    function pointDivIcon(p){ const size=Math.max(16,Math.min(48,Number(p.pointSize||24)));
      const k=p.pointIcon||"warning"; const svg=POINT_ICONS[k]||POINT_ICONS.warning;
      return L.divIcon({ html:`<div class="pticon" style="width:${size}px;height:${size}px;color:${POINT_COLOR}">${svg}</div>`, className:"", iconSize:[size,size], iconAnchor:[size/2,size/2]});
    }
    function getQualityColor(name){ const q=(metaQualities||[]).find(x=>x.name===name); return q? q.color :
      name==="hladký" ? "#22c55e" : name==="ok" ? "#f59e0b" : name==="výtluky" ? "#ef4444" : name==="nebezpečí" ? "#111827" : "#38bdf8"; }
    function guessSurfaceIcon(n){ n=(n||"").toLowerCase(); if(n.includes("dlaž")||n.includes("kostk"))return"brick";
      if(n.includes("štěrk")||n.includes("prach"))return"pebble"; if(n.includes("schod"))return"stairs";
      if(n.includes("dřevo")||n.includes("lávk"))return"plank"; if(n.includes("hlín")||n.includes("nezpev"))return"triangle"; return"dot"; }
    function surfaceDef(p){ if(p.surfaceIcon||p.surfaceRepeat) return {icon:p.surfaceIcon||guessSurfaceIcon(p.surface), repeat:Number(p.surfaceRepeat||28)};
      const by=(metaSurfaces||[]).find(s=>s.name===p.surface); return by? {icon:by.icon, repeat:Number(by.repeat||28)} : {icon:guessSurfaceIcon(p.surface), repeat:28}; }

    // ===== legenda =====
    let metaSurfaces=null, metaQualities=null;
    function renderLegend(){
      const bar=document.getElementById("legend"); bar.innerHTML=""; bar.style.display="flex";
      (metaQualities||[]).forEach(q=>{ const chip=document.createElement("span"); chip.className="chip";
        chip.innerHTML=`<span class="sw" style="background:${q.color}"></span><span>${q.name}</span>`; bar.appendChild(chip); });
      (metaSurfaces||[]).forEach(s=>{ const chip=document.createElement("span"); chip.className="chip";
        chip.innerHTML=`<span class="iconbox">${ICON_SVGS[s.icon]||ICON_SVGS.dot}</span><span>${s.name}</span>`; bar.appendChild(chip); });
      const labels={warning:"pozor",speed_bump:"retardér",zavora:"závora",railcross:"přejezd",pin:"bod"};
      ["warning","speed_bump","zavora","railcross","pin"].forEach(k=>{ const chip=document.createElement("span"); chip.className="chip";
        chip.innerHTML=`<span class="iconbox"><div class="pticon" style="width:18px;height:18px;color:${POINT_COLOR}">${POINT_ICONS[k]}</div></span><span>${labels[k]}</span>`; bar.appendChild(chip); });
    }

    // ===== ikonky po čáře =====
    function placeIconsForLine(layer){
      if(layer._iconMarkers){ layer._iconMarkers.forEach(m=>iconsLayer.removeLayer(m)); layer._iconMarkers=null; }
      const p = (layer.feature||layer.toGeoJSON()).properties||{};
      const def = surfaceDef(p); const repeat=Math.max(8,Number(def.repeat||28)); const icon=lineIcon(def.icon);
      const latlngs=layer.getLatLngs(); if(!Array.isArray(latlngs)||latlngs.length<2) return;
      const pts=latlngs.flat?latlngs.flat():latlngs; const pix=pts.map(ll=>map.latLngToLayerPoint(ll));
      let seg=[], total=0; for(let i=0;i<pix.length-1;i++){ const d=Math.hypot(pix[i+1].x-pix[i].x, pix[i+1].y-pix[i].y); seg.push(d); total+=d; }
      const markers=[]; for(let d=0; d<=total; d+=repeat){ let acc=0, k=-1; for(let i=0;i<seg.length;i++){ if(acc+seg[i]>=d){k=i;break} acc+=seg[i]; }
        if(k<0) continue; const A=pix[k], B=pix[k+1], L=seg[k], t=L?(d-acc)/L:0; const x=A.x+(B.x-A.x)*t, y=A.y+(B.y-A.y)*t;
        const ll=map.layerPointToLatLng(L.point(x,y)); const m=L.marker(ll,{icon,interactive:false,keyboard:false}); iconsLayer.addLayer(m); markers.push(m); }
      layer._iconMarkers=markers;
    }
    map.on("zoomend moveend", ()=> drawn.eachLayer(l=>{ if(l instanceof L.Polyline && !(l instanceof L.Polygon)) placeIconsForLine(l); }));

    // ===== styly / popupy =====
    function styleFor(f){ const p=f.properties||{}; if(f.geometry&&f.geometry.type==="Point") return {};
      return { color: p.color||getQualityColor(p.quality), weight: Number(p.width||6), opacity:.95 }; }
    function pointToLayer(f,latlng){ return L.marker(latlng,{icon:pointDivIcon(f.properties||{})}); }
    function onEachFeature(f,layer){
      const p=f.properties||{}; const lines=[];
      if(f.geometry.type==="Point"){ if(p.pointIcon) lines.push(`<b>${p.pointIcon}</b>`); }
      else { if(p.surface) lines.push(`<b>${p.surface}</b>`); if(p.quality) lines.push(p.quality); }
      if(p.tag) lines.push(`<i>${p.tag}</i>`); if(p.note) lines.push(String(p.note).replace(/</g,"&lt;"));
      if(lines.length) layer.bindPopup(lines.join("<br>"));
      if(layer instanceof L.Polyline && !(layer instanceof L.Polygon)) placeIconsForLine(layer);
    }

    // ===== načítání s automatickým fallbackem =====
    async function tryFetch(url){
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { mode:"cors" });
      if(!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText}`);
      return await res.json();
    }

    async function load(){
      const candidates = [];
      if (DATA_URL_OVERRIDE) candidates.push(["Parametr ?data", DATA_URL_OVERRIDE]);
      if (GOOGLE_API_KEY && DRIVE_FILE_ID) candidates.push(["Google Drive API", DRIVE_API_URL]);
      candidates.push(["Soubor v repu", LOCAL_DATA_URL]);                 // ./data.geojson
      candidates.push(["Alternativní název", "./mapdata.geojson"]);       // pro jistotu

      let lastErr = null;
      for (const [label, url] of candidates){
        try{
          const fc = await tryFetch(url);
          if (!fc || fc.type!=="FeatureCollection") throw new Error("Není FeatureCollection");
          metaSurfaces = (fc.meta && Array.isArray(fc.meta.surfaces)) ? fc.meta.surfaces : null;
          metaQualities = (fc.meta && Array.isArray(fc.meta.qualities)) ? fc.meta.qualities : null;
          L.geoJSON(fc,{style:styleFor,pointToLayer,onEachFeature}).addTo(drawn);
          try{ const bb = drawn.getBounds(); if(bb.isValid()) map.fitBounds(bb.pad(0.1)); }catch{}
          renderLegend();
          showBanner(`Načteno z: ${label} ✔`);
          return;
        }catch(err){
          lastErr = `${label}: ${err.message}`;
          console.warn("Nepodařilo se:", label, err);
        }
      }
      showBanner(`Nepodařilo se načíst data. ${lastErr||""}`, true);
    }

    load();
  </script>
</body>
</html>
