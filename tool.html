<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESK8 GPS logger</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body {
  margin: 0;
  background: #0b1220;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background: #0f172a;
  padding: 10px 12px;
  border-bottom: 1px solid #1f2937;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
h1 { font-size: 16px; margin: 0; }
.status {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  background: #111827;
}
.actions {
  padding: 10px;
  background: #0f172a;
  display: flex;
  gap: 8px;
  justify-content: space-between;
  flex-wrap: wrap;
  border-bottom: 1px solid #1f2937;
}
button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}
button#start { background: #16a34a; color: #041805; }
button#pause { background: #f59e0b; color: #1a1300; }
button#stop { background: #ef4444; color: #fff; }
button#export { background: #374151; color: #fff; }
button#clear { background: #991b1b; color: #fff; }

#map { flex: 1; }
</style>
</head>
<body>
<header>
  <h1>ESK8 GPS logger</h1>
  <span id="status" class="status">připraveno</span>
</header>

<div class="actions">
  <button id="start">Start</button>
  <button id="pause">Pauza</button>
  <button id="stop">Stop</button>
  <button id="export">Export</button>
  <button id="clear">Smazat</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([50.08, 14.43], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap',
}).addTo(map);

const lines = L.featureGroup().addTo(map);
const live = L.layerGroup().addTo(map);

let tracking = false;
let paused = false;
let watchId = null;
let current = [];
let features = [];

const statusEl = document.getElementById('status');

function setStatus(txt, color = '#111827') {
  statusEl.textContent = txt;
  statusEl.style.background = color;
}

function start() {
  if (tracking) return;
  tracking = true; paused = false;
  setStatus('běží', '#16a34a');
  current = [];
  if (navigator.geolocation) {
    watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy: true
    });
  } else {
    alert('Geolokace není dostupná.');
  }
}

function pause() {
  paused = true;
  setStatus('pauza', '#f59e0b');
}

function stop() {
  tracking = false;
  paused = false;
  setStatus('zastaveno', '#ef4444');
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  if (current.length > 1) {
    const line = L.polyline(current, {color: '#22c55e', weight: 5}).addTo(lines);
    features.push({
      type: "Feature",
      geometry: { type: "LineString", coordinates: current.map(c => [c[1], c[0]]) },
      properties: { createdAt: new Date().toISOString() }
    });
  }
  current = [];
}

function onPos(pos) {
  if (!tracking || paused) return;
  const { latitude, longitude, accuracy } = pos.coords;
  current.push([latitude, longitude]);
  updateLive(latitude, longitude, accuracy);
}

function updateLive(lat, lon, acc) {
  live.clearLayers();
  const m = L.circleMarker([lat, lon], {radius:6, color:'#3b82f6'}).addTo(live);
  L.circle([lat, lon], {radius: acc, color:'#3b82f6', weight:1, fillOpacity:.1}).addTo(live);
  map.setView([lat, lon]);
}

function onErr(e) {
  console.warn('geo error', e);
  setStatus('chyba polohy', '#f87171');
}

function exportData() {
  if (current.length > 1) stop();
  const fc = {
    type: "FeatureCollection",
    features: features
  };
  const blob = new Blob([JSON.stringify(fc, null, 2)], { type: "application/geo+json" });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "esk8-track.geojson";
  a.click();
  setStatus('soubor exportován', '#22c55e');
}

function clearData() {
  if (!confirm('Opravdu smazat vše?')) return;
  lines.clearLayers();
  live.clearLayers();
  features = [];
  current = [];
  setStatus('vyčištěno', '#991b1b');
}

document.getElementById('start').onclick = start;
document.getElementById('pause').onclick = pause;
document.getElementById('stop').onclick = stop;
document.getElementById('export').onclick = exportData;
document.getElementById('clear').onclick = clearData;

setStatus('připraveno');
</script>
</body>
</html>
