<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESK8 ‚Äì GPS logger (povrch ‚Ä¢ kvalita ‚Ä¢ ikony)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --muted:#9ca3af; --txt:#e5e7eb; --border:#1f2937; --acc:#22c55e; --warn:#f59e0b; --err:#ef4444; --blue:#3b82f6; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{display:flex;flex-direction:column;min-height:100vh}

    header{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{margin:0;font-size:16px}
    .status{font-size:12px;padding:4px 8px;border-radius:999px;background:#111827;border:1px solid var(--border)}

    /* v√Ωbƒõry */
    .controls{padding:10px 12px;display:grid;gap:8px;background:var(--panel);border-bottom:1px solid var(--border)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0b1020;font-size:13px;cursor:pointer;user-select:none}
    .chip.active{outline:2px solid rgba(255,255,255,.06);background:#111b2e}
    .sw{width:14px;height:14px;border-radius:50%;border:1px solid rgba(255,255,255,.25)}
    .iconbox{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center}

    /* tlaƒç√≠tka nad mapou */
    .actions{padding:10px 12px;background:#0f172a;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .btnbar{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    button{padding:12px;border-radius:12px;border:1px solid var(--border);background:#111827;color:var(--txt);font:inherit;cursor:pointer}
    button.primary{background:#16a34a;border-color:#16a34a;color:#051807}
    button.warn{background:var(--warn);border-color:var(--warn);color:#1a1300}
    button.danger{background:var(--err);border-color:var(--err);color:#fff}
    .legend{padding:8px 0;color:var(--muted);font-size:12px;border-top:1px dashed #243349;margin-top:8px}

    /* upload tlaƒç√≠tko mezi akcemi a mapou */
    .uploadbar{padding:12px; background:#0f172a; border-bottom:1px solid var(--border); text-align:center}
    .uploadbtn{display:inline-block; padding:12px 18px; background:var(--acc); color:#04230e; font-weight:700; border-radius:12px; text-decoration:none; border:1px solid var(--acc)}
    .uploadbtn:hover{ filter:brightness(1.05) }
    .uploadhint{color:var(--muted); font-size:12px; margin-top:6px}

    /* mapa */
    #map{flex:1; min-height:45vh}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ESK8 GPS logger</h1>
      <span id="status" class="status">p≈ôipraveno</span>
    </header>

    <!-- 3 ≈ô√°dky voleb -->
    <section class="controls">
      <div class="row" id="rowSurfaces"></div>
      <div class="row" id="rowQualities"></div>
      <div class="row" id="rowIcons"></div>
    </section>

    <!-- tlaƒç√≠tka (NAD mapou) -->
    <section class="actions">
      <div class="btnbar">
        <button id="btnStart" class="primary">Start</button>
        <button id="btnPause" class="warn">Pauza</button>
        <button id="btnStop" class="danger">Stop</button>
        <button id="btnExport">Export</button>
        <button id="btnDelete" class="danger">Smazat</button>
      </div>
      <div class="legend" id="legend"></div>
    </section>

    <!-- odkaz na Google Form (MEZI tlaƒç√≠tky a mapou) -->
    <div class="uploadbar">
      <a class="uploadbtn" href="https://forms.gle/2VNdXTozK66ZQKUNA" target="_blank" rel="noopener noreferrer">
        üì§ Zde nahraj geojson soubor, abysme ho zadali do mapy, d√≠ky üíö
      </a>
      <div class="uploadhint">Otev≈ôe se ve nov√© z√°lo≈æce (Google Form).</div>
    </div>

    <!-- mapa -->
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ====== Datov√© slovn√≠ky ======
  const ICON_SVGS = {
    dot:'<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="3.2" fill="#fff" stroke="#111" stroke-width="1.3"/></svg>',
    brick:'<svg width="16" height="16" viewBox="0 0 16 16"><rect x="2" y="4" width="12" height="8" fill="#fff" stroke="#111" stroke-width="1"/><path d="M2 8 H14 M6 4 V8 M10 8 V12" stroke="#111" stroke-width="1"/></svg>',
    pebble:'<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="5" cy="8" r="2.4" fill="#fff" stroke="#111" stroke-width="1"/><circle cx="11" cy="6" r="1.9" fill="#fff" stroke="#111" stroke-width="1"/><circle cx="11" cy="11" r="1.5" fill="#fff" stroke="#111" stroke-width="1"/></svg>',
    stairs:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M4 12 H12 V10 H10 V8 H8 V6 H6 V4 H4 Z" fill="#fff" stroke="#111" stroke-width="1.1"/></svg>',
    plank:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M2 5 H14 M2 8 H14 M2 11 H14" stroke="#111" stroke-width="1.6"/></svg>',
    triangle:'<svg width="16" height="16" viewBox="0 0 16 16"><path d="M8 3 L13 13 H3 Z" fill="#fff" stroke="#111" stroke-width="1.3"/></svg>'
  };
  const SURFACES = [
    {name:'asfalt', icon:'dot', repeat:28},
    {name:'dla≈æba / kostky', icon:'brick', repeat:28},
    {name:'≈°tƒõrk / prach', icon:'pebble', repeat:28},
    {name:'schody', icon:'stairs', repeat:32},
    {name:'d≈ôevo / l√°vka', icon:'plank', repeat:32},
    {name:'hl√≠na', icon:'triangle', repeat:30}
  ];
  const QUALITIES = [
    {name:'hladk√Ω', color:'#22c55e'},
    {name:'ok', color:'#f59e0b'},
    {name:'v√Ωtluky', color:'#ef4444'},
    {name:'nebezpeƒç√≠', color:'#111827'}
  ];
  const POINT_ICONS = [
    { key:'warning', label:'pozor', svg:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M12 3L2.5 20h19L12 3z" fill="white" stroke="currentColor" stroke-width="2"/><path d="M12 8v6M12 18h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>' },
    { key:'speed_bump', label:'retard√©r', svg:'<svg viewBox="0 0 24 24" width="100%" height="100%"><circle cx="12" cy="12" r="9" fill="white" stroke="currentColor" stroke-width="2"/><path d="M6 14c2-3 10-3 12 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="5" y1="14" x2="19" y2="14" stroke="currentColor" stroke-width="2"/></svg>'},
    { key:'zavora', label:'z√°vora', svg:'<svg viewBox="0 0 24 24" width="100%" height="100%"><rect x="4" y="15" width="3" height="6" fill="white" stroke="currentColor" stroke-width="2"/><rect x="17" y="15" width="3" height="6" fill="white" stroke="currentColor" stroke-width="2"/><rect x="5" y="9" width="14" height="4" rx="1" fill="white" stroke="currentColor" stroke-width="2"/><path d="M6 9.5 L9 12.5 M9 9.5 L12 12.5 M12 9.5 L15 12.5 M15 9.5 L18 12.5" stroke="currentColor" stroke-width="2"/></svg>' },
    { key:'railcross', label:'p≈ôejezd', svg:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M5 5 L19 19" stroke="white" stroke-width="6" stroke-linecap="round"/><path d="M19 5 L5 19" stroke="white" stroke-width="6" stroke-linecap="round"/><path d="M5 5 L19 19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><path d="M19 5 L5 19" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>' },
    { key:'pin', label:'bod', svg:'<svg viewBox="0 0 24 24" width="100%" height="100%"><path d="M12 22s7-6.5 7-12a7 7 0 10-14 0c0 5.5 7 12 7 12z" fill="white" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="10" r="2.5" fill="currentColor"/></svg>' }
  ];

  // ====== UI render ======
  const rowSurfaces = document.getElementById('rowSurfaces');
  const rowQualities = document.getElementById('rowQualities');
  const rowIcons = document.getElementById('rowIcons');
  const statusEl = document.getElementById('status');

  let selSurface = SURFACES[0];
  let selQuality = QUALITIES[0];

  function renderSurfaces(){
    rowSurfaces.innerHTML='';
    SURFACES.forEach((s)=>{
      const chip=document.createElement('div'); chip.className='chip'+(s===selSurface?' active':'');
      const icon=document.createElement('span'); icon.className='iconbox'; icon.innerHTML=ICON_SVGS[s.icon]||ICON_SVGS.dot; chip.appendChild(icon);
      chip.appendChild(Object.assign(document.createElement('span'),{textContent:s.name}));
      chip.addEventListener('click', ()=>{ selSurface=s; renderSurfaces(); if(tracking) startNewSegment('surface-change'); renderLegend(); });
      rowSurfaces.appendChild(chip);
    });
  }
  function renderQualities(){
    rowQualities.innerHTML='';
    QUALITIES.forEach(q=>{
      const chip=document.createElement('div'); chip.className='chip'+(q===selQuality?' active':'');
      const sw=document.createElement('span'); sw.className='sw'; sw.style.background=q.color; chip.appendChild(sw);
      chip.appendChild(Object.assign(document.createElement('span'),{textContent:q.name}));
      chip.addEventListener('click', ()=>{ selQuality=q; renderQualities(); if(tracking) startNewSegment('quality-change'); renderLegend(); });
      rowQualities.appendChild(chip);
    });
  }
  function renderIcons(){
    rowIcons.innerHTML='';
    POINT_ICONS.forEach(pi=>{
      const chip=document.createElement('div'); chip.className='chip';
      const size=18; const html=`<div style="width:${size}px;height:${size}px;color:#ef4444">${pi.svg}</div>`;
      const box=document.createElement('span'); box.className='iconbox'; box.innerHTML=html; chip.appendChild(box);
      chip.appendChild(Object.assign(document.createElement('span'),{textContent:pi.label}));
      chip.addEventListener('click', ()=> addSinglePoint(pi.key));
      rowIcons.appendChild(chip);
    });
  }
  renderSurfaces(); renderQualities(); renderIcons();

  // ====== Mapa ======
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; OpenStreetMap'}).addTo(map);
  const linesLayer = L.featureGroup().addTo(map);
  const pointsLayer = L.featureGroup().addTo(map);
  const liveLayer = L.layerGroup().addTo(map);

  function colorForQuality(name){ const q=QUALITIES.find(x=>x.name===name); return q? q.color : '#38bdf8'; }
  function pointDivIcon(p){
    const size=24; const color='#ef4444';
    const meta = POINT_ICONS.find(x=>x.key===p.pointIcon) || POINT_ICONS[0];
    const html = `<div style="width:${size}px;height:${size}px;color:${color}">${meta.svg}</div>`;
    return L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
  }
  function lineStyle(p){ return { color: colorForQuality(p.quality), weight: 6, opacity:0.95 } }

  // ====== Geologger + LIVE poloha ======
  let tracking=false, paused=false, watchId=null, previewWatchId=null, lastFix=null;
  let currentSegment=null;
  const features=[];

  let liveMarker=null, liveAccuracy=null;
  function updateLiveMarker(lat, lon, acc){
    if(typeof lat!=='number' || typeof lon!=='number') return;
    const ll=[lat,lon];
    const blue = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#3b82f6';
    if(!liveMarker){
      liveMarker = L.circleMarker(ll, { radius:6, color: blue, fill:true, fillOpacity:1, weight:2 });
      liveAccuracy = L.circle(ll, { radius: Math.max(5, acc||10), color: blue, weight:1, fillOpacity:.08 });
      liveMarker.addTo(liveLayer); liveAccuracy.addTo(liveLayer);
      map.setView(ll, 16);
    } else {
      liveMarker.setLatLng(ll);
      liveAccuracy.setLatLng(ll);
      if(typeof acc==='number' && isFinite(acc)) liveAccuracy.setRadius(Math.max(5, acc));
    }
  }

  function setStatus(txt, hue){ statusEl.textContent=txt; statusEl.style.background=hue||'#111827'; }

  function startNewSegment(reason){
    if(currentSegment && currentSegment.coords.length>1){ finalizeSegment(); }
    const props={
      type:'LineString',
      surface: selSurface.name, surfaceIcon: selSurface.icon, surfaceRepeat: selSurface.repeat,
      quality: selQuality.name, color: colorForQuality(selQuality.name), width:6,
      createdAt: new Date().toISOString(), reason
    };
    const layer=L.polyline([], lineStyle(props)).addTo(linesLayer);
    const feat={ type:'Feature', properties: props, geometry:{ type:'LineString', coordinates:[] } };
    layer.feature=feat;
    currentSegment={ layer, coords:[], times:[], props };
  }
  function finalizeSegment(){
    if(!currentSegment) return;
    const {layer, coords, times, props}=currentSegment;
    if(coords.length<2){ linesLayer.removeLayer(layer); currentSegment=null; return; }
    layer.feature.geometry.coordinates = coords.slice();
    layer.feature.properties.times = times.slice();
    layer.setStyle(lineStyle(props));
    features.push(layer.feature);
    currentSegment=null;
  }

  function onPosition(pos){
    const c={ lat:pos.coords.latitude, lon:pos.coords.longitude, acc:pos.coords.accuracy, ts:new Date(pos.timestamp||Date.now()).toISOString() };
    lastFix=c; updateLiveMarker(c.lat, c.lon, c.acc);
    if(!tracking || paused) return;
    if(!currentSegment) startNewSegment('first-fix');

    // krok ~3 m
    if(currentSegment.coords.length){
      const prev=currentSegment.coords[currentSegment.coords.length-1];
      const d=haversine(prev[0], prev[1], c.lon, c.lat);
      if(d<3) return;
    }
    currentSegment.coords.push([c.lon, c.lat]);
    currentSegment.times.push(c.ts);
    currentSegment.layer.addLatLng([c.lat, c.lon]);
  }
  function onError(err){ setStatus('chyba geolokace', 'var(--err)'); console.warn(err); }

  // preview poloha (p≈ôed startem)
  function startPreviewWatch(){
    if(!('geolocation' in navigator)) return;
    if(previewWatchId!=null) return;
    previewWatchId = navigator.geolocation.watchPosition((pos)=>{
      const c={ lat:pos.coords.latitude, lon:pos.coords.longitude, acc:pos.coords.accuracy };
      lastFix=c; updateLiveMarker(c.lat, c.lon, c.acc);
    }, (e)=>{ console.warn('preview geo err', e); }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  }
  function stopPreviewWatch(){ if(previewWatchId!=null){ navigator.geolocation.clearWatch(previewWatchId); previewWatchId=null; } }

  function start(){
    if(tracking) return; tracking=true; paused=false; setStatus('bƒõ≈æ√≠','var(--acc)');
    stopPreviewWatch();
    if(!watchId){ watchId = navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy:true, maximumAge:3000, timeout:20000 }); }
    if(lastFix){ map.setView([lastFix.lat,lastFix.lon], 17); }
  }
  function pause(){ paused=true; setStatus('pauza','var(--warn)'); }
  function stop(){
    paused=false; tracking=false; setStatus('zastaveno','var(--warn)');
    finalizeSegment();
    if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
    startPreviewWatch();
  }

  // Haversine (m)
  function haversine(lon1, lat1, lon2, lat2){
    const toRad = d => d*Math.PI/180; const R=6371000; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  // jednor√°zov√° ikona
  function addSinglePoint(key){
    if(!lastFix){ alert('Je≈°tƒõ nem√°m polohu. Dej Start a poƒçkej na fix.'); return; }
    const p={ pointIcon:key, createdAt:new Date().toISOString(), type:'Point' };
    const feat={ type:'Feature', properties: p, geometry:{ type:'Point', coordinates:[ lastFix.lon, lastFix.lat ] } };
    const m=L.marker([lastFix.lat,lastFix.lon], { icon: pointDivIcon(p) }).addTo(pointsLayer); m.feature=feat; features.push(feat);
  }

  // Export (Sd√≠let ‚Üí download ‚Üí otev≈ô√≠t v nov√© z√°lo≈æce)
  async function doExport(){
    if(currentSegment && currentSegment.coords.length>1){ finalizeSegment(); }
    const pack={ type:'FeatureCollection', features, meta:{
      surfaces:SURFACES, qualities:QUALITIES, pointIcons: POINT_ICONS.map(x=>({key:x.key,label:x.label}))
    } };
    const json=JSON.stringify(pack,null,2);
    const blob=new Blob([json],{type:'application/geo+json'});
    const fileName='esk8-track.geojson';

    try{
      const file = new File([blob], fileName, {type:'application/geo+json'});
      if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({files:[file], title:'ESK8 track', text:'GeoJSON'});
        setStatus('exportov√°no ‚Äì Sd√≠let','#16a34a'); return;
      }
    }catch{}

    try{
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fileName; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1200);
      setStatus('soubor sta≈æen','#16a34a'); return;
    }catch(e){ console.warn('download blocked', e); }

    try{
      const url = URL.createObjectURL(blob);
      const w = window.open(url, '_blank');
      if(!w){
        const data='data:application/geo+json;charset=utf-8,'+encodeURIComponent(json);
        window.open(data,'_blank');
      }
      setStatus('otev≈ôeno v nov√© z√°lo≈æce (ulo≈æ ruƒçnƒõ)','#16a34a');
    }catch(e){
      alert('Export se nepoda≈ôil. Zkus otev≈ô√≠t Tool mimo iframe nebo povolit stahov√°n√≠.');
      setStatus('export selhal','#ef4444');
    }
  }

  // Smazat
  function deleteCurrentRecord(){
    const ok = confirm('Opravdu smazat aktu√°ln√≠ z√°znam? Tato akce je nevratn√°.');
    if(!ok) return;
    if(currentSegment){ try{ /* odstranit nedokonƒçen√Ω layer */ }catch{} currentSegment = null; }
    linesLayer.clearLayers(); pointsLayer.clearLayers();
    features.length = 0; setStatus('z√°znam smaz√°n','var(--err)');
  }

  // Handlery
  document.getElementById('btnStart').addEventListener('click', ()=>{ if(!('geolocation' in navigator)){ alert('Prohl√≠≈æeƒç nepodporuje geolokaci.'); return; } start(); });
  document.getElementById('btnPause').addEventListener('click', ()=> pause());
  document.getElementById('btnStop').addEventListener('click', ()=> stop());
  document.getElementById('btnExport').addEventListener('click', ()=> doExport());
  document.getElementById('btnDelete').addEventListener('click', ()=> deleteCurrentRecord());

  // init ‚Äì a≈• je poloha vidƒõt hned
  if(navigator.geolocation){ startPreviewWatch(); } else { map.setView([50.0755,14.4378], 13); }

  // legenda
  function renderLegend(){
    const el=document.getElementById('legend');
    el.innerHTML = `Povrch: <b>${selSurface.name}</b> ‚Ä¢ Kvalita: <span style="color:${colorForQuality(selQuality.name)}"><b>${selQuality.name}</b></span>`;
  }
  renderLegend();
  rowSurfaces.addEventListener('click', renderLegend, true);
  rowQualities.addEventListener('click', renderLegend, true);
  </script>
</body>
</html>
